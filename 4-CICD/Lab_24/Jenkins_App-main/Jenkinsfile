@Library('ci-lib') _

pipeline {
  agent { label 'docker' }

  environment {
    APP_DIR    = '4-CICD/Lab_24/Jenkins_App-main'
    IMAGE_NAME = 'imaisalama/jenkins-app'
    IMAGE_TAG  = "${BUILD_NUMBER}"
  }

  stages {

    stage('Detect Environment') {
      steps {
        script {
          if (env.BRANCH_NAME == 'dev') {
            env.K8S_NAMESPACE = 'dev'
          } else if (env.BRANCH_NAME == 'stag') {
            env.K8S_NAMESPACE = 'stag'
          } else if (env.BRANCH_NAME == 'prod') {
            env.K8S_NAMESPACE = 'prod'
          } else {
            error "Unsupported branch: ${env.BRANCH_NAME}"
          }

          echo "Branch: ${env.BRANCH_NAME}"
          echo "Namespace: ${env.K8S_NAMESPACE}"
        }
      }
    }

    stage('RunUnitTest') {
      steps {
        runUnitTest(APP_DIR)
      }
    }

    stage('BuildApp') {
      steps {
        buildApp(APP_DIR)
      }
    }

    stage('BuildImage') {
      steps {
        buildImage(APP_DIR, IMAGE_NAME, IMAGE_TAG)
      }
    }

    stage('ScanImage') {
      steps {
        scanImage(IMAGE_NAME, IMAGE_TAG)
      }
    }

    stage('PushImage') {
      steps {
        pushImage(IMAGE_NAME, IMAGE_TAG)
      }
    }

    stage('RemoveImageLocally') {
      steps {
        removeImageLocally(IMAGE_NAME, IMAGE_TAG)
      }
    }

    stage('DeployOnK8s') {
      steps {
        script {
          def ns = env.K8S_NAMESPACE
          echo "DEBUG: Deploying using namespace = ${ns}"

          dir(APP_DIR) {

        sh """
          set -e

          echo "ðŸš€ Deploying to namespace: ${namespace}"

          # Sanity checks
          kubectl version --client
          kubectl cluster-info

          # Ensure namespace exists
          kubectl get namespace ${namespace} >/dev/null 2>&1 \
            || kubectl create namespace ${namespace}

          # Update image tag
          sed -i 's|image:.*|image: ${imageName}:${imageTag}|g' deployment.yaml

          echo "ðŸ“¦ Updated deployment.yaml:"
          grep image deployment.yaml

          # Apply manifests
          kubectl apply -f deployment.yaml -n ${namespace}

          # Wait for rollout
          kubectl rollout status deployment/jenkins-app \
            -n ${namespace} \
            --timeout=120s
        """
    }
        }
      }
    }
  }

  post {
    success {
      echo "Deployment to ${env.K8S_NAMESPACE} successful ðŸŽ‰"
    }
    failure {
      echo 'Pipeline failed'
    }
  }
}
